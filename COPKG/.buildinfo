/* target information */
@import "version.inc";

#define {
    NewVersion : "${package-version++}";
}

#product-info  {
	product-name: "lua";
	version: "5.2.0";
	original-source-location: "http://www.lua.org/ftp/lua-5.2.0.tar.gz";
	original-source-website: "http://www.lua.org/";
	license: "MIT";
	packager: "Hamish C";
}

test {
    set: {
        COMP="${COMP??vc10}",
        PLAT="${PLAT??x86, x64}",
    };
    uses: release;
    build-command: @"
	    REM this is the test recommended in the docs...
		REM need to find something better though
        for %%A in (${COMP}) do (
            for %%B in (${PLAT}) do (
                Release\%%A\%%B\lua -v
            )
        )
    ";
};

package {
    set: {
        COMP="${COMP??vc10}",
        PLAT="${PLAT??x86, x64}",
    };
    uses: {
        update-version,
        sign,
    };
    targets: { 
        (COMP,PLAT) => @"copkg\lua-dev[${0}]-${NewVersion}-${1}.msi",
    };
    build-command : @"
        cd COPKG
        autopackage lua-dev-common.autopkg || goto failed
        for %%A in (${COMP}) do (
            for %%B in (${PLAT}) do (
                autopackage lua[%%A]-x86.autopkg lua-dev[vc10]-x86.autopkg || goto failed
            )
        )
    ";
	clean-command: @"del COPKG\*.msi COPKG\*.wixpdb";
};


update-version {
    build-command : @"
        REM auto-increment version.inc file...
        if ""${noversion}"" == ""true"" goto :endver
        pushd COPKG
        setlocal EnableDelayedExpansion
        set VERSTRING=#define { package-version: ${NewVersion}; }
        echo !VERSTRING! > version.inc
        popd
        :endver
    ";
}

release {
    set: {
        BuildCfg="Release",
        COMP="${COMP??vc10}",
        PLAT="${PLAT??x86, x64}",
    };
    build-command: @"
        if ""${BUILT}"" equ ""true"" goto endrel
        for %%A in (${COMP}) do (
            for %%B in (${PLAT}) do (
                ptk --nologo base --COMP=%%A --PLAT=%%B || goto failed
            )
        )
        :endrel
    ";
    clean-command:@"
       if exist Release rmdir /s /q Release > nul 2> nul
    ";
};

sign {
    uses: release;
    build-command: @"simplesigner.exe --nologo --sign Release\**.dll Release\**.exe || goto failed";
};

/*
x86 {
    default : false;
    compiler: vc10;
    platform: x86;

    targets: { 
		"Release\x86\lua5.2.lib",
		"Release\x86\lua5.2.dll",
		"Release\x86\lua.exe",
		"Release\x86\luac.exe",
	};
	
    build-command:@"
		msbuild /p:Platform=win32 /p:Configuration=Release COPKG\lua\lua.sln
	";
    
    clean-command:@"
       if exist Release rmdir /s /q Release > nul 2> nul
       if exist COPKG\lua\Release rmdir /s /q COPKG\lua\Release > nul 2> nul
       if exist COPKG\lua\ipch rmdir /s /q COPKG\lua\ipch > nul 2> nul
       del /S /Q /A - *.sdf *.suo *.user *.exe *.pdb  > nul 2>NUL
    ";
};

x64 {
    default : false;
    compiler: vc10;
    platform: x64;

    targets: { 
		"Release\x64\lua5.2.lib",
		"Release\x64\lua5.2.dll",
		"Release\x64\lua.exe",
		"Release\x64\luac.exe",
	};
	
    build-command:@"
        msbuild /p:Platform=x64 /p:Configuration=Release COPKG\lua\lua.sln
    ";
    clean-command:@"
       if exist Release rmdir /s /q Release > nul 2> nul
       if exist COPKG\lua\Release rmdir /s /q COPKG\lua\Release > nul 2> nul
       if exist COPKG\lua\ipch rmdir /s /q COPKG\lua\ipch > nul 2> nul
       del /S /Q /A - *.sdf *.suo *.user *.exe *.pdb  > nul 2>NUL
    ";
};
*/

base {
    set: {
        COMP="${COMP??vc10}",
        PLAT="${PLAT??x86}",
        BuildCfg="${BuildCfg??Debug}",
    };
    compiler: "${COMP}";
    platform: "${PLAT}";

    targets: { 
		"${BuildCfg}\${COMP}\${PLAT}\lua5.2.lib",
		"${BuildCfg}\${COMP}\${PLAT}\lua5.2.dll",
		"${BuildCfg}\${COMP}\${PLAT}\lua.exe",
		"${BuildCfg}\${COMP}\${PLAT}\luac.exe",
	};
	
    build-command:@"
        if ""${PLAT}"" equ ""x86"" (
            msbuild /p:Platform=win32 /p:Configuration=${BuildCfg} COPKG\lua\lua.sln
        ) else (
            msbuild /p:Platform=${PLAT} /p:Configuration=${BuildCfg} COPKG\lua\lua.sln
        )
    ";
    clean-command:@"
       if exist ${BuildCfg}\${COMP}\${PLAT} rmdir /s /q ${BuildCfg}\${COMP}\${PLAT} > nul 2> nul
       if exist COPKG\lua\${BuildCfg} rmdir /s /q COPKG\lua\${BuildCfg} > nul 2> nul
       if exist COPKG\lua\ipch rmdir /s /q COPKG\lua\ipch > nul 2> nul
       del /S /Q /A - *.sdf *.suo *.user *.exe *.pdb  > nul 2>NUL
    ";
};
